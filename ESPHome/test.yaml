esphome:
  name: test
  friendly_name: test

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:
  level: VERBOSE

# Enable Home Assistant API
api:
  encryption:
    key: "woEwhhYP0YUh+Ylo+nuqrvbIgj5xBve2Dfr4E7YTmU0="

ota:
  - platform: esphome
    password: "96082af7d8a9662fd4ee72603d63fecb"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Test Fallback Hotspot"
    password: "LI5uj3U6nb90"

external_components:
  - source: "../../ESPHome-DFRobot-pH-Meter/components/"
    components: [dfrobot_ph_meter]

globals:
  - id: pump_power
    type: bool
    restore_value: no
    initial_value: "false"

  - id: pump_pressure_delay_s
    type: int
    initial_value: "10"

  - id: solenoid_period_s
    type: int
    restore_value: yes
    initial_value: "30"

  - id: solenoid_duty_cycle
    type: int
    restore_value: yes
    initial_value: "50"

  - id: on_time_ms
    type: int

  - id: off_time_ms
    type: int

mqtt:
  broker: !secret mqtt_broker_ip_address

dfrobot_ph_meter:
  id: ph_sensor
  use_ads1115: false
  adc_pin: 1
  update_interval: 10s
  probe_status_sensor:
    name: "Probe Status"
    state_topic: "tower/1/sensor/ph/status"
  # Optional sensors for diagnostics
  raw_voltage_sensor:
    name: "pH Raw Voltage"
    state_topic: "tower/1/sensor/ph/voltage"
  ph_sensor:
    name: "pH Sensor"
    accuracy_decimals: 2
    state_topic: "tower/1/sensor/ph"
  calibration_mode:
    name: "pH Calibration Mode"
    state_topic: "tower/1/sensor/ph/calibration"
    command_topic: "tower/1/control/ph/calibration"
  # Optional: Custom calibration buffer values
  ph4_solution: 3.02 # Default: 4.0
  ph7_solution: 6.86 # Default: 7.0
  ph10_solution: 9.18 # Default: 10.0
  # Noise reduction settings
  smoothing_alpha: 0.2 # Default: 0.2 (range 0.01-1.0, lower = more smoothing
  median_samples: 5 # Default: 5 (range 1-10, higher = better noise rejection)