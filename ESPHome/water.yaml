esphome:
  name: water
  friendly_name: water

esp32:
  board: esp32-s3-devkitc-1
  framework:
    type: esp-idf

# Enable logging
logger:
  level: VERBOSE

# Enable Home Assistant API
api:
  encryption:
    key: "wdyJ//Lkrup6TGZeSpISo7hSS+eMIjaa+ps3NeLGnKA="

ota:
  - platform: esphome
    password: "4a1d7c64dc75b03445cd863d9cef6672"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Water Fallback Hotspot"
    password: "nmP5a0yeWf6U"

external_components:
  - source: "../../ESPHome-DFRobot-pH-Meter/components/"
    components: [dfrobot_ph_meter]

globals:
  - id: pump_power
    type: bool
    restore_value: no
    initial_value: "false"

  - id: pump_pressure_delay_s
    type: int
    initial_value: "10"

  - id: solenoid_period_s
    type: int
    restore_value: yes
    initial_value: "30"

  - id: solenoid_duty_cycle
    type: int
    restore_value: yes
    initial_value: "50"

  - id: on_time_ms
    type: int

  - id: off_time_ms
    type: int

  - id: ph4_calibration_voltage
    type: float
    restore_value: yes
    initial_value: "1268.0"

  - id: ph7_calibration_voltage
    type: float
    restore_value: yes
    initial_value: "1650.0"

  - id: ph10_calibration_voltage
    type: float
    restore_value: yes
    initial_value: "2032.0"

mqtt:
  broker: !secret mqtt_broker_ip_address
  on_message:
    - topic: tower/1/control/solenoid-period
      then:
        - lambda: |-
            id(solenoid_period_s) = atoi(x.c_str());
            ESP_LOGI("solenoid", "Updated period: %d s", id(solenoid_period_s));
        - script.execute: solenoid_cycle

    - topic: tower/1/control/solenoid-duty-cycle
      then:
        - lambda: |-
            id(solenoid_duty_cycle) = atoi(x.c_str());
            ESP_LOGI("solenoid", "Updated duty cycle: %d%%", id(solenoid_duty_cycle));
        - script.execute: solenoid_cycle # restart with new settings

    - topic: tower/1/control/pump-power
      then:
        - lambda: |-
            bool new_state = (x == "on");

            if (new_state == id(pump_power)) {
              ESP_LOGI("pump", "Pump-power command ignored (already %s)", new_state ? "on" : "off");
              return;
            }

            id(pump_power) = new_state;
            ESP_LOGI("pump", "Pump power changed to: %s", new_state ? "on" : "off");

            if (new_state) {
              id(pump_start_sequence).execute();
            } else {
              id(solenoid_cycle).stop();
              id(solenoid).turn_off();
              id(pump).turn_off();
            }

switch:
  - platform: gpio
    pin: GPIO21
    id: solenoid
    name: "Solenoid valve relay"
    inverted: True

  - platform: gpio
    pin: GPIO18
    id: pump
    name: "Pump power relay"
    inverted: True

sensor:
  - platform: ultrasonic
    trigger_pin: GPIO11
    echo_pin: GPIO12
    name: "Water level"
    id: water_level
    update_interval: 10s
    state_class: measurement
    state_topic: "tower/1/sensor/water-level"

  - platform: dallas_temp
    address: 0x6e00000ff96afe28 # GPIO4
    name: "Water temperature"
    id: water_temp
    update_interval: 10s
    state_class: measurement
    state_topic: "tower/1/sensor/temp-water"

  - platform: adc
    name: "Water pressure"
    id: water_pressure
    pin: GPIO14
    attenuation: auto
    filters:
      - lambda: |-
          const float calibration_offset = 0.49407;       
          float voltage= x;                       
          float kpa = (voltage - calibration_offset) * 250.0;    
          float bar = kpa / 100;
          if (bar < 0) bar = 0;                  
          return bar;
    update_interval: 10s
    state_class: measurement
    state_topic: "tower/1/sensor/pressure"

  - platform: adc
    id: ph_voltage
    name: "pH Raw Voltage"
    unit_of_measurement: "mV"
    pin: ${ph_pin}
    attenuation: auto
    update_interval: 1s
    filters:
      - multiply: 1000.0 # to mV
      - median:
          window_size: 9
          send_every: 1
          send_first_at: 1
      - exponential_moving_average:
          alpha: 0.1
          send_every: 1
    internal: true

  - platform: template
    id: ph
    name: "pH"
    unit_of_measurement: "pH"
    accuracy_decimals: 2
    update_interval: 10s
    lambda: |-
      constexpr float KELVIN_OFFSET = 273.15f;
      constexpr float NERNST_REF_TEMP = 25.0f;
      float voltage = id(ph_voltage).state;   
      float ph4_vol  = id(ph4_calibration_voltage);   
      float ph7_vol  = id(ph7_calibration_voltage);    
      float ph10_vol = id(ph10_calibration_voltage);    
      float temp = 25.0f;

      if (id(water_temp).has_state()) // Ensure temp has value
        temp = id(water_temp).state;

      float temp_factor =
        (temp + KELVIN_OFFSET) / (NERNST_REF_TEMP + KELVIN_OFFSET);

      float slope;
      if (voltage< ph7_vol) {
        // Acidic side: slope between pH4–7
        slope = (ph7_vol - ph4_vol) / (7.0f - 4.0f);
      } else {
        // Alkaline side: slope between pH7–10
        slope = (ph10_vol - ph7_vol) / (10.0f - 7.0f);
      }

      slope *= temp_factor;
      float ph = 7.0f + (voltage- ph7_vol) / slope;

      if (ph < 0.0f) ph = 0.0f;
      if (ph > 14.0f) ph = 14.0f;
      return ph;
    state_class: measurement
    state_topic: "tower/1/sensor/ph"

    # TODO: EC sensor when done

one_wire:
  - platform: gpio
    pin: ${water_temp_pin}

script:
  - id: solenoid_cycle
    mode: restart
    then:
      - lambda: |-
          if (!id(pump_power)) {
            id(solenoid).turn_off();
            return;
          }
      - lambda: |-
          int period = id(solenoid_period_s);
          int duty   = id(solenoid_duty_cycle);

          int on_time  = (period * duty) / 100;
          int off_time = period - on_time;

          id(on_time_ms)  = on_time  * 1000;
          id(off_time_ms) = off_time * 1000;

          ESP_LOGI("solenoid", "ON: %d ms, OFF: %d ms", id(on_time_ms), id(off_time_ms));

      - switch.turn_on: solenoid
      - delay: !lambda |-
          if (!id(pump_power)) return 0; 
          return id(on_time_ms);
      - switch.turn_off: solenoid
      - delay: !lambda |-
          if (!id(pump_power)) return 0;
          return id(off_time_ms);
      - if:
          condition:
            lambda: "return id(pump_power);"
          then:
            - script.execute: solenoid_cycle
  - id: pump_start_sequence
    mode: restart
    then:
      - switch.turn_on: pump
      - delay: !lambda "return id(pump_pressure_delay_s) * 1000;"
      - if:
          condition:
            lambda: "return id(pump_power);"
          then:
            - logger.log: "Starting solenoid cycle after pressure delay"
            - script.execute: solenoid_cycle
          else:
            - logger.log: "Pump was turned off during delay; solenoid cycle not started"

interval:
  - interval: 10s
    then:
      - mqtt.publish:
          topic: "tower/1/sensor/solenoid-period"
          payload: !lambda |-
            return to_string(id(solenoid_period_s));
      - mqtt.publish:
          topic: "tower/1/sensor/solenoid-duty-cycle"
          payload: !lambda |-
            return to_string(id(solenoid_duty_cycle));
      - mqtt.publish:
          topic: "tower/1/sensor/pump-power"
          payload: !lambda |-
            return id(pump_power) ? "on" : "off";
  - interval: 30s
    then:
      - if:
          condition:
            lambda: |-
              return id(pump_power) && !id(solenoid_cycle).is_running();
          then:
            - logger.log: "Watchdog: restarting solenoid cycle"
            - script.execute: solenoid_cycle
